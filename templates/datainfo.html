<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body style="margin: 32px;">
    <span class="title">{{ id }} </span> <br>
    <hr>
    <span class="subtitle">List of tables</span> <br>
    <span id="schema"></span>
    <hr>
    <span class="subtitle">Execute SQLite query</span> <br>
    Here you can edit a query to be executed in your database, you may lose data if used incorrectly. <br>
    If you have just created the database, that database is empty, you have to run a query to create at least one table.
    <div id="text-editor"></div>
    <button class="primary wide" onclick="execute(aceEditor.getValue())">Execute query</button>
    <hr>
    <span id="frames" class="subtitle">iFrame previews</span><br>
    Here you can view your database iframes before using them in your app, be sure to enter a table name first. You can edit the files using an external code editor. <br><br>
    <label for="table-name">Table name:</label>
    <input type="text" name="table-name" id="table-name">
    <table style="table-layout: fixed; width: 200px;">
        <tr>
            <td><button onclick="databaseFrame.src = '/database/list/{{id}}/' + tableName.value;" >Gallery</button></td>
            <td><button onclick="databaseFrame.src = '/database/new_item/{{id}}/' + tableName.value;">New form</button></td>
        </tr>
    </table>
    <iframe id="database-frame" style="width: 100%; height: 400px; padding: 10px;" src="" frameborder="1"></iframe>
    <hr>
    <span class="subtitle">Create app</span> <br>
    Quickly create an application based on this table. <br><br>
    <label for="table-app">Table name:</label>
    <input type="text" name="table-app" id="table-app"> <br> <br>
    
    <button class="primary wide" onclick="popup_table_name()">Create app</button>
    <br><br>
    <script src="/static/js/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/js/src-min-noconflict/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/js/src-min-noconflict/mode-html.js" type="text/javascript" charset="utf-8"></script>
    <script>
        forbiddenchars = /[`!@#$%^&*()+=\[\]{};':"\\|,.<>\/?~ ]/;
        urlsave = "/database/exec/{{ id }}";
        const databaseFrame = document.getElementById("database-frame");
        const tableName = document.getElementById("table-name");
        const tableApp = document.getElementById("table-app");
        aceEditor = ace.edit("text-editor");
        aceEditor.session.setUseWrapMode(true);
        aceEditor.session.setMode("ace/mode/sql");
        aceEditor.setValue("{{ schema }}");
        tables = JSON.parse('{{ tables | safe }}'.replace(/'/g, '"'));
        apps = JSON.parse("{{ projects | safe }}".replace(/'/g, '"'));

        if (tables.length == 0){
            document.getElementById("schema").innerHTML += "You have not created any table yet";
        }

        for (let x = 0; x < tables.length; x++) {
            document.getElementById("schema").innerHTML += "<button onclick='goto(\"" + tables[x][0] + "\")'>" + tables[x][0] + "</button>";
            
        }
        document.getElementById("schema").innerHTML += "<br><span style='font-size:14px; color: rgba(0,0,0,0.5);'>" + tables.length + " table/s in total</span>";

        function goto(table){
            window.open("#frames", "_self");
            tableName.value = table;
            tableApp.value = table;
        }

        function execute(final_command){
            fetch(urlsave, {
                method: "POST",
                body: JSON.stringify({"final_command": final_command}),
                headers: {"Content-type": "application/json; charset=UTF-8"}
            })
            .then(response => console.log(response))
            .then(alert("Query executed. Refresh page if needed"))
            .catch(err => console.log(err));
        }

        function popup_table_name(){
            table_name = prompt("Enter the name of your app. Make sure it doesn't exist");
            cancel = false;
            if ( ! table_name){
                alert("Can't create this app\nIt doesn't have a name")
            } else if (forbiddenchars.test(table_name)){
                alert("Can't create this app\nIt contains special characters")
            } else {
                for (let x = 0; x < apps.length; x++) {
                    if (apps[x] == table_name){
                        cancel = true;
                        alert("Can't create " + table_name + "\nThis app already exists");
                    }
                }
                if (! cancel)
                    genapp(tableApp.value, table_name);
            }
        }

        function genapp(table, name){
            xmldata = `<App DisplayName="My App" DefaultScreen="Screen0" Width="800" Height="480" OAVer="0.20"><Screen Name="Screen0" Style="position:%20relative;%20width:%20100%25;%20height:%20100%25;%20overflow:%20hidden;%20background-color:%20rgb(255,%20255,%20255);" OnVisible="g%20=%20document.getElementById(%22gal%22)"><Children Type="Label" Name="Database" Text="%3Cspan%20style=%22display:flex;%20margin:%2032px;%20flex:%201;%22%3E%0A%09%3Ciframe%20id=%22gal%22%20src=%22/database/list/{{ id }}/` + table + `%22%20frameborder=%220%22%20style=%22flex:%201;%22%3E%3C/iframe%3E%0A%3C/span%3E" X="109" Y="5" OnSelect="null" Style="display:%20flex;%20position:%20absolute;%20overflow:%20hidden;%20user-select:%20none;%20transform:%20translate(109px,%205px);%20width:%20691px;%20height:%20475px;%20background-color:%20rgb(255,%20255,%20255);%20background-repeat:%20no-repeat;%20background-attachment:%20fixed;%20background-position:%20center%20center;%20background-size:%20contain;%20font-size:%2015px;%20visibility:%20visible;"/><Children Type="Button" Name="Plus" Text="" X="36" Y="38" OnSelect="g.src%20=%20%22/database/new_item/{{ id }}/` + table + `%22;" Style="position:%20absolute;%20text-align:%20center;%20display:%20flex;%20justify-content:%20center;%20align-items:%20center;%20overflow:%20hidden;%20user-select:%20none;%20transform:%20translate(36px,%2038px);%20width:%2064px;%20height:%2060px;%20background-color:%20rgb(255,%20255,%20255);%20background-repeat:%20no-repeat;%20background-attachment:%20fixed;%20background-position:%20center%20center;%20background-size:%20contain;%20color:%20rgb(255,%20255,%20255);%20border:%200px;%20border-radius:%2010px;%20font-size:%2015px;%20visibility:%20visible;%20background-image:%20url(%22data:image/svg+xml,%253Csvg%20viewBox='0%200%2020%2020'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20fill='%2523000000'%253E%253Cg%20id='SVGRepo_bgCarrier'%20stroke-width='0'%253E%253C/g%253E%253Cg%20id='SVGRepo_tracerCarrier'%20stroke-linecap='round'%20stroke-linejoin='round'%253E%253C/g%253E%253Cg%20id='SVGRepo_iconCarrier'%253E%253Cg%20id='layer1'%253E%253Cpath%20d='M%209%203%20L%209%2010%20L%202%2010%20L%202%2011%20L%209%2011%20L%209%2018%20L%2010%2018%20L%2010%2011%20L%2017%2011%20L%2017%2010%20L%2010%2010%20L%2010%203%20L%209%203%20z%20'%20style='fill:%2523222222;%20fill-opacity:1;%20stroke:none;%20stroke-width:0px;'%253E%253C/path%253E%253C/g%253E%253C/g%253E%253C/svg%253E%22);"/><Children Type="Button" Name="Back" Text="" X="38" Y="120" OnSelect="g.contentWindow.history.back();" Style="position:%20absolute;%20text-align:%20center;%20display:%20flex;%20justify-content:%20center;%20align-items:%20center;%20overflow:%20hidden;%20user-select:%20none;%20transform:%20translate(38px,%20120px);%20width:%2064px;%20height:%2060px;%20background-color:%20rgb(255,%20255,%20255);%20background-repeat:%20no-repeat;%20background-attachment:%20fixed;%20background-position:%20center%20center;%20background-size:%20contain;%20color:%20rgb(255,%20255,%20255);%20border:%200px;%20border-radius:%2010px;%20font-size:%2015px;%20visibility:%20visible;%20background-image:%20url(%22data:image/svg+xml,%253Csvg%20viewBox='0%200%201024%201024'%20xmlns='http://www.w3.org/2000/svg'%20fill='%2523000000'%253E%253Cg%20id='SVGRepo_bgCarrier'%20stroke-width='0'%253E%253C/g%253E%253Cg%20id='SVGRepo_tracerCarrier'%20stroke-linecap='round'%20stroke-linejoin='round'%253E%253C/g%253E%253Cg%20id='SVGRepo_iconCarrier'%253E%253Cpath%20fill='%2523000000'%20d='M224%20480h640a32%2032%200%201%201%200%2064H224a32%2032%200%200%201%200-64z'%253E%253C/path%253E%253Cpath%20fill='%2523000000'%20d='m237.248%20512%20265.408%20265.344a32%2032%200%200%201-45.312%2045.312l-288-288a32%2032%200%200%201%200-45.312l288-288a32%2032%200%201%201%2045.312%2045.312L237.248%20512z'%253E%253C/path%253E%253C/g%253E%253C/svg%253E%22);"/><Children Type="Button" Name="Refresh" Text="" X="38" Y="199" OnSelect="g.contentWindow.location.reload();" Style="position:%20absolute;%20text-align:%20center;%20display:%20flex;%20justify-content:%20center;%20align-items:%20center;%20overflow:%20hidden;%20user-select:%20none;%20transform:%20translate(38px,%20199px);%20width:%2064px;%20height:%2060px;%20background-color:%20rgb(255,%20255,%20255);%20background-repeat:%20no-repeat;%20background-attachment:%20fixed;%20background-position:%20center%20center;%20background-size:%20contain;%20color:%20rgb(255,%20255,%20255);%20border:%200px;%20border-radius:%2010px;%20font-size:%2015px;%20visibility:%20visible;%20background-image:%20url(%22data:image/svg+xml,%253Csvg%20fill='%2523000000'%20viewBox='0%200%2032%2032'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%253E%253Cg%20id='SVGRepo_bgCarrier'%20stroke-width='0'%253E%253C/g%253E%253Cg%20id='SVGRepo_tracerCarrier'%20stroke-linecap='round'%20stroke-linejoin='round'%253E%253C/g%253E%253Cg%20id='SVGRepo_iconCarrier'%253E%253Cpath%20d='M15.544%2028.080c-0.002-0.006-0.008-0.010-0.012-0.015l-2.873-4.489c-0.204-0.335-0.646-0.454-0.992-0.266l-0.256%200.157c-0.344%200.188-0.337%200.673-0.133%201.008l1.841%202.857c-0.157-0.035-0.316-0.063-0.471-0.103-3.224-0.843-5.953-3.026-7.485-5.988-1.448-2.797-1.72-5.99-0.766-8.992s3.118-5.452%205.915-6.899c0.476-0.247%200.662-0.832%200.416-1.308-0.246-0.477-0.832-0.663-1.308-0.416-3.258%201.686-5.763%204.54-6.874%208.036s-0.794%207.215%200.892%2010.473c1.786%203.448%204.963%205.989%208.72%206.973%200.043%200.011%200.087%200.017%200.13%200.028l-2.541%201.288c-0.344%200.189-0.458%200.613-0.254%200.948l0.098%200.256c0.205%200.335%200.557%200.454%200.9%200.266l4.651-2.381c0.006-0.004%200.012-0.003%200.018-0.007l0.312-0.171c0.172-0.095%200.287-0.249%200.332-0.422%200.047-0.172%200.025-0.364-0.076-0.531zM28.559%2010.025c-1.783-3.447-4.862-5.988-8.618-6.972-0.267-0.070-0.541-0.124-0.814-0.179l2.494-1.265c0.344-0.189%200.549-0.614%200.345-0.949l-0.099-0.255c-0.205-0.336-0.648-0.454-0.991-0.267l-4.651%202.381c-0.006%200.003-0.012%200.002-0.018%200.006l-0.312%200.171c-0.173%200.095-0.287%200.249-0.332%200.422-0.047%200.172-0.025%200.364%200.077%200.53l0.185%200.304c0.003%200.006%200.008%200.010%200.012%200.016l2.873%204.489c0.203%200.335%200.646%200.454%200.991%200.266l0.226-0.157c0.344-0.188%200.366-0.673%200.163-1.008l-1.85-2.87c0.407%200.063%200.811%200.138%201.207%200.242%203.226%200.845%205.856%203.027%207.387%205.986%201.448%202.797%201.72%205.99%200.765%208.991s-3.020%205.451-5.818%206.901c-0.476%200.247-0.662%200.831-0.415%201.308%200.172%200.332%200.511%200.524%200.863%200.524%200.15%200%200.302-0.035%200.446-0.109%203.259-1.686%205.664-4.54%206.776-8.035%201.111-3.497%200.794-7.217-0.893-10.473z'%253E%253C/path%253E%253C/g%253E%253C/svg%253E%22);"/></Screen></App>`;
            fetch("/save", {
                method: "POST",
                body: JSON.stringify({
                    "id": name,
                    "xmldata": xmldata,
                    "screen" : 1
                }),
                headers: {"Content-type": "application/json; charset=UTF-8"}
            })
            .then(response => console.log(response)) 
            .then(alert("App " + name + " created"))
            .catch(err => console.log(err));
        }
    </script>
</body>
</html>